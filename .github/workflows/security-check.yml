name: Security and Quality Check

on:
  pull_request:
    branches: [ main, dev ]
  push:
    branches: [ main, dev ]

jobs:
  # Job 1: ÊéÉÊèèÊïèÊÑüË≥áÊñô
  secret-scan:
    name: üîç Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Áç≤ÂèñÂÆåÊï¥Ê≠∑Âè≤‰ª•ÊéÉÊèèÊâÄÊúâ commits
      
      # TruffleHog - ÊéÉÊèè secrets Âíå credentials
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@v3.63.7
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
      
      # ‰ΩøÁî® detect-secrets Êõø‰ª£ GitleaksÔºàÁ∞°ÂåñÁâàÔºåÂè™Ê™¢Êü•ÁúüÂØ¶ÁöÑÊïèÊÑüË≥áÊñôÔºâ
      - name: Detect Secrets
        run: |
          echo "Scanning for real secrets patterns..."
          
          # ÂÆöÁæ©ÁúüÂØ¶ÊïèÊÑüË≥áÊñôÁöÑÊ®°Âºè
          FOUND_SECRETS=0
          
          # Ê™¢Êü•ÁúüÂØ¶ÁöÑ Supabase URL Âíå KeysÔºà‰∏çÊòØÁØÑ‰æãÔºâ
          if grep -r "supabase\.co" --include="*.js" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=.git --exclude="*.example.*" | \
            grep -v "your-supabase-url" | grep -v "placeholder" | grep -v "example"; then
            echo "‚ùå Found hardcoded Supabase URLs"
            FOUND_SECRETS=1
          fi
          
          # Ê™¢Êü• JWT tokensÔºàÊéíÈô§ÁØÑ‰æãÔºâ
          if grep -r "eyJ[A-Za-z0-9_-]\{20,\}\.[A-Za-z0-9_-]\{20,\}\.[A-Za-z0-9_-]\{20,\}" \
            --include="*.js" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=.git --exclude="*.example.*" | \
            grep -v "your-" | grep -v "placeholder" | grep -v "test"; then
            echo "‚ùå Found JWT tokens"
            FOUND_SECRETS=1
          fi
          
          # Ê™¢Êü•ÁúüÂØ¶ÁöÑË≥áÊñôÂ∫´ÈÄ£Á∑öÂ≠ó‰∏≤
          if grep -r "postgresql://[^:]*:[^@]*@[^/]*/[^\"' ]*" \
            --include="*.js" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=.git --exclude="*.example.*" | \
            grep -v "username:password" | grep -v "localhost" | grep -v "placeholder"; then
            echo "‚ùå Found database connection strings"
            FOUND_SECRETS=1
          fi
          
          # Ê™¢Êü• API KeysÔºàÊéíÈô§ÊòéÈ°ØÁöÑÁØÑ‰æãÔºâ
          if grep -r -E "(api[_-]?key|secret[_-]?key|access[_-]?key)\s*[:=]\s*[\"'][A-Za-z0-9_-]{32,}[\"']" \
            --include="*.js" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=.git --exclude="*.example.*" | \
            grep -v "your-" | grep -v "test-" | grep -v "placeholder" | grep -v "example" | \
            grep -v "SECRET_KEY" | grep -v "API_KEY"; then
            echo "‚ùå Found API keys"
            FOUND_SECRETS=1
          fi
          
          if [ $FOUND_SECRETS -eq 1 ]; then
            exit 1
          else
            echo "‚úÖ No real secrets detected"
          fi
      
      # Ëá™Ë®ÇÊ™¢Êü• - Á¢∫‰øùÊ≤íÊúâÁí∞Â¢ÉÊ™îÊ°à
      - name: Check for Environment Files
        run: |
          # Ê™¢Êü•ÊòØÂê¶Êúâ env Áõ∏ÈóúÊ™îÊ°àÔºàÊéíÈô§ iOS ÈúÄË¶ÅÁöÑ .xcode.env Ê™îÊ°àÔºâ
          UNWANTED_ENV=$(find . -type f \( -name "*.env*" -o -name "env" \) \
            ! -path "./.git/*" \
            ! -path "./node_modules/*" \
            ! -path "./ios/.xcode.env" \
            ! -path "./ios/.xcode.env.local" \
            ! -name ".xcode.env*")
          
          if [ ! -z "$UNWANTED_ENV" ]; then
            echo "‚ùå Found environment files that should not be committed:"
            echo "$UNWANTED_ENV"
            echo "Please add them to .gitignore"
            exit 1
          fi
          echo "‚úÖ No problematic environment files found"
      
      # Ê™¢Êü•Ê™îÊ°àÂêçÁ®±Ê®°Âºè
      - name: Check for Unwanted Files
        run: |
          # Ê™¢Êü•ÂÇô‰ªΩÂíåÂûÉÂúæÊ™îÊ°à
          UNWANTED=$(find . -type f \( \
            -name "*.backup" -o \
            -name "*.bak" -o \
            -name "*.old" -o \
            -name "*.orig" -o \
            -name "*.tmp" -o \
            -name "*.temp" -o \
            -name "*.swp" -o \
            -name "*.swo" -o \
            -name "*~" -o \
            -name ".DS_Store" -o \
            -name "Thumbs.db" \
          \) ! -path "./.git/*" ! -path "./node_modules/*")
          
          if [ ! -z "$UNWANTED" ]; then
            echo "‚ùå Found unwanted files:"
            echo "$UNWANTED"
            exit 1
          fi
          echo "‚úÖ No unwanted files found"
      
      # Ê™¢Êü•Êï∏Â≠óÁµêÂ∞æÁöÑË≥áÊñôÂ§æÂíåÊ™îÊ°à
      - name: Check for Numbered Folders and Files
        run: |
          # Â∞ãÊâæÁ©∫Ê†º+Êï∏Â≠óÁµêÂ∞æÁöÑË≥áÊñôÂ§æ
          NUMBERED_DIRS=$(find . -type d -regex ".*/[^/]+ [0-9]+" ! -path "./.git/*" ! -path "./node_modules/*")
          COPY_DIRS=$(find . -type d -regex ".*/[^/]+ copy" ! -path "./.git/*" ! -path "./node_modules/*")
          
          # Â∞ãÊâæÁ©∫Ê†º+Êï∏Â≠óÁµêÂ∞æÁöÑÊ™îÊ°àÔºàÂÉèÊòØ .xcode.env 2.localÔºâ
          NUMBERED_FILES=$(find . -type f -regex ".*/[^/]+ [0-9]+\.[^/]+" ! -path "./.git/*" ! -path "./node_modules/*")
          
          if [ ! -z "$NUMBERED_DIRS" ] || [ ! -z "$COPY_DIRS" ] || [ ! -z "$NUMBERED_FILES" ]; then
            echo "‚ùå Found backup/duplicate folders or files:"
            [ ! -z "$NUMBERED_DIRS" ] && echo "Folders with numbers: $NUMBERED_DIRS"
            [ ! -z "$COPY_DIRS" ] && echo "Copy folders: $COPY_DIRS"
            [ ! -z "$NUMBERED_FILES" ] && echo "Files with numbers: $NUMBERED_FILES"
            exit 1
          fi
          echo "‚úÖ No backup folders or files found"

  # Job 2: Á®ãÂºèÁ¢ºÂìÅË≥™Ê™¢Êü•
  code-quality:
    name: üìù Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
        continue-on-error: true  # Êö´ÊôÇÂÖÅË®± lint ÈåØË™§
      
      - name: Run Type Check
        run: npm run type-check
        continue-on-error: true  # Êö´ÊôÇÂÖÅË®± type ÈåØË™§
      
      - name: Check for console.log statements
        run: |
          # Âú®ÁîüÁî¢‰ª£Á¢º‰∏≠Ê™¢Êü• console.logÔºàÊéíÈô§Ê∏¨Ë©¶Ê™îÊ°àÔºâ
          CONSOLE_LOGS=$(grep -r "console\.log" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules \
            --exclude-dir=.git \
            --exclude-dir=__tests__ \
            --exclude-dir=tests \
            --exclude="*.test.*" \
            --exclude="*.spec.*" \
            . || true)
          
          if [ ! -z "$CONSOLE_LOGS" ]; then
            echo "‚ö†Ô∏è  Warning: Found console.log statements in code:"
            echo "$CONSOLE_LOGS"
            echo "Consider removing them before production deployment"
          fi

  # Job 3: ‰æùË≥¥ÊÄßÂÆâÂÖ®ÊéÉÊèè
  dependency-check:
    name: üîí Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=high || true
          echo "Note: High and critical vulnerabilities should be addressed"

  # Job 4: Ê™îÊ°àÂ§ßÂ∞èÊ™¢Êü•
  size-check:
    name: üì¶ File Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for large files
        run: |
          # Ê™¢Êü•Ë∂ÖÈÅé 5MB ÁöÑÊ™îÊ°à
          echo "Checking for large files..."
          find . -type f -size +5M ! -path "./.git/*" ! -path "./node_modules/*" -exec ls -lh {} \; | while read line; do
            echo "‚ö†Ô∏è  Warning: Large file (>5MB): $line"
          done
          echo "Note: Consider using Git LFS for large files if needed"
          
  # Á∏ΩÁµê Job
  summary:
    name: ‚úÖ Security Check Summary
    needs: [secret-scan, code-quality, dependency-check, size-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "üéâ Security and quality checks completed!"
          echo ""
          echo "Results:"
          echo "- Secret Scan: ${{ needs.secret-scan.result }}"
          echo "- Code Quality: ${{ needs.code-quality.result }}"
          echo "- Dependency Check: ${{ needs.dependency-check.result }}"
          echo "- Size Check: ${{ needs.size-check.result }}"
          
          if [ "${{ needs.secret-scan.result }}" = "failure" ]; then
            echo ""
            echo "‚ùå CRITICAL: Secret scan failed! Fix immediately!"
            exit 1
          fi