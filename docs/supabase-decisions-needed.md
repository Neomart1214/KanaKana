# Supabase 整合 - 待決定事項

本文件列出開始 KanaKana Supabase 整合前需要做的所有關鍵決策。

## 🔐 1. 認證策略

### 用戶註冊流程
- [ ] **方案 A：匿名優先** - 允許用戶無需註冊即可遊玩，之後提示儲存進度
  - 優點：更好的用戶體驗，降低進入門檻
  - 缺點：用戶註冊時的資料遷移複雜
  
- [ ] **方案 B：強制註冊** - 從一開始就要求登入
  - 優點：資料管理簡單，所有功能立即可用
  - 缺點：進入門檻較高，可能流失休閒玩家

### 社群登入優先順序
請按實作優先順序排序：
- [ ] Google 登入（Android 主要）
- [ ] Apple 登入（iOS 要求）
- [ ] Email/密碼（傳統方式）
- [ ] LINE 登入（台灣/日本熱門）
- [ ] Facebook 登入
- [ ] X (Twitter) 登入

## 📊 2. 資料遷移策略

### 現有用戶資料
目前用戶有儲存在 AsyncStorage 的本地資料（設定、偏好等）

- [ ] **方案 A：遷移工具** - 建立工具將現有本地資料遷移到 Supabase
  - 優點：保留用戶進度
  - 缺點：實作複雜，可能有 bug
  
- [ ] **方案 B：全新開始** - 將 Supabase 版本視為新應用
  - 優點：實作乾淨，沒有遺留問題
  - 缺點：用戶失去現有進度
  
- [ ] **方案 C：手動匯出/匯入** - 讓用戶自行匯出/匯入資料
  - 優點：用戶控制，選擇性遷移
  - 缺點：額外的 UI/UX 工作

## 📚 3. 詞彙資料載入策略

### 初始資料載入
- [ ] **方案 A：打包核心詞彙** - 在應用程式包中包含必要詞彙
  - 優點：從一開始就可離線使用，初始體驗更快
  - 缺點：應用程式較大（+10-15MB）
  
- [ ] **方案 B：首次啟動下載** - 首次執行時下載所有詞彙
  - 優點：應用程式較小，總是最新資料
  - 缺點：首次啟動需要網路，初始設定較慢
  
- [ ] **方案 C：漸進式下載** - 遊戲過程中按需下載
  - 優點：最小初始下載，有效利用頻寬
  - 缺點：可能中斷遊戲，需要良好的離線備援
  
- [ ] **方案 D：混合方法** - 打包基礎，下載進階
  - 優點：平衡離線能力和應用程式大小
  - 缺點：維護兩個資料來源更複雜

## 🛠️ 4. 技術架構

### ORM 決策
- [ ] **使用 Prisma ORM** - 如目前遷移計畫所述
  - 優點：型別安全，遷移管理，熟悉網頁開發
  - 缺點：額外複雜度，較大的套件，主要是伺服器端優勢
  
- [ ] **直接使用 Supabase Client** - 直接使用 Supabase JS SDK
  - 優點：更簡單，套件較小，為客戶端設計
  - 缺點：型別安全較少，手動遷移管理

### 資料庫 Schema 方法
- [ ] **單一 Schema** - 所有資料在 public schema
- [ ] **多重 Schema** - 不同功能分開 schemas（遊戲、社交等）

## 🏆 5. 成就系統設計

### 成就定義
- [ ] **寫死在應用程式** - 成就定義在程式碼中
  - 優點：不需網路，即時檢查
  - 缺點：新增成就需要應用程式更新
  
- [ ] **資料庫驅動** - 成就定義在 Supabase
  - 優點：動態更新，可進行 A/B 測試
  - 缺點：需要網路，更複雜

### 解鎖邏輯執行
- [ ] **客戶端檢查** - 應用程式檢查並授予成就
  - 優點：即時回饋，離線可用
  - 缺點：容易作弊
  
- [ ] **伺服器端驗證** - 資料庫觸發器或 Edge Functions
  - 優點：安全，一致
  - 缺點：需要網路，可能延遲

### 防作弊措施
- [ ] 無防作弊（信任用戶）
- [ ] 基本驗證（合理分數範圍）
- [ ] 所有成就的伺服器端驗證
- [ ] 遊戲過程的加密證明

## 📈 6. 排行榜範圍

### 排行榜類型（選擇所有適用）
- [ ] 全球 - 全世界所有玩家
- [ ] 區域 - 按國家/地區
- [ ] 好友 - 需要好友系統
- [ ] 群組/俱樂部 - 自訂排行榜

### 時間範圍（選擇所有適用）
- [ ] 歷史最高
- [ ] 每月
- [ ] 每週
- [ ] 每日
- [ ] 最近 24 小時（滾動）

### 顯示限制
- [ ] 僅顯示前 10 名
- [ ] 前 100 名
- [ ] 顯示玩家位置 + 周圍排名
- [ ] 分頁無限滾動

## 🔄 7. 版本相容性

### 資料庫遷移策略
- [ ] **自動遷移** - 應用程式處理 schema 更新
- [ ] **強制更新** - DB 變更需要應用程式更新
- [ ] **版本化 API** - 維護多個 API 版本

### 向後相容政策
- [ ] 支援最後 2 個主要版本
- [ ] 支援最近 3 個月的版本
- [ ] 無向後相容（強制最新版）

## 💰 8. Supabase 層級規劃

### 預期規模
請估計：
- 預期每月活躍用戶：________
- 預期每日活躍用戶：________
- 每用戶每日平均工作階段：________
- 每工作階段詞彙查詢：________

### 免費層級限制（目前）
- 500MB 資料庫
- 1GB 儲存空間
- 2GB 頻寬
- 50,000 每月活躍用戶

### 何時升級？
- [ ] 從免費開始，需要時升級
- [ ] 從 Pro 開始（$25/月）以獲得更好限制
- [ ] 需要企業規劃

## 🔧 9. 開發環境

### Supabase 專案設定
- [ ] **單一專案** - 所有環境使用相同專案，不同 schemas/前綴
  - 優點：更簡單，成本效益
  - 缺點：資料混合風險
  
- [ ] **多個專案** - 開發/測試/正式分開專案
  - 優點：完全隔離，更安全
  - 缺點：管理更多，潛在成本更高

### 分支策略
- [ ] 功能分支與預覽部署
- [ ] 開發 → 測試 → 正式流程
- [ ] 直接到正式（YOLO）

## 🎯 10. 實作優先順序

### 第一階段（MVP）- 選擇首次發布功能：
- [ ] 基本認證（Email + 一個社群提供者）
- [ ] 遊戲進度雲端儲存
- [ ] 簡單全球排行榜
- [ ] 詞彙雲端同步
- [ ] 用戶個人檔案

### 第二階段 - 下一批要新增的功能：
- [ ] 成就系統
- [ ] 每日挑戰
- [ ] 好友系統
- [ ] 進階排行榜
- [ ] 用戶生成內容

### 第三階段（未來）- 長期目標：
- [ ] 即時多人遊戲
- [ ] 自訂詞彙包
- [ ] 錦標賽
- [ ] 付費功能/訂閱
- [ ] 分析儀表板

## 📝 其他考量

### 隱私與合規
- [ ] 需要 GDPR 合規？
- [ ] 需要 COPPA 合規（13 歲以下用戶）？
- [ ] 資料存放地要求？

### 營利模式（如適用）
- [ ] 完全免費
- [ ] 廣告與付費去廣告
- [ ] 付費功能（訂閱）
- [ ] 一次性購買升級
- [ ] 應用程式內購買

### 支援與維護
- [ ] 僅自助服務
- [ ] Email 支援
- [ ] 應用程式內支援聊天
- [ ] 社群論壇

---

## 決策總結

做出決策後，在此記錄：

**決策日期：** 2025-08-22

**決策者：** hcy

### 最終決定：

1. **認證方式**：
   - ✅ 方案 A：匿名優先（允許匿名遊玩，資料不會自動遷移到註冊帳戶）
   - ✅ 社群登入：Google + Apple Sign-In

2. **資料遷移**：
   - ✅ 方案 B：全新開始（目前沒有重要進度需要保留）

3. **詞彙載入**：
   - ✅ 方案 C：漸進式下載（按需下載，處理好同步機制）

4. **架構選擇**：
   - ✅ 使用 Prisma ORM（強制要求，用於 DB schema 版控）
   - ✅ 多重 Schema 設計

5. **成就系統**：
   - ✅ 資料庫驅動（成就定義存在 Supabase）
   - ✅ 伺服器端驗證（防作弊）
   - 註：目前尚未實作成就系統

6. **排行榜**：
   - ✅ 全球排行榜
   - ✅ 所有時間範圍（歷史/月/週/日）
   - ✅ 顯示前 100 名
   - 註：目前尚未實作排行榜

7. **版本政策**：
   - ✅ 重大 schema 更新時強制更新
   - ✅ 基本向後相容設計
   - ✅ 版本控制決定是否需要更新

8. **Supabase 層級**：
   - ✅ 初期使用免費層級
   - ✅ 視成長情況升級

9. **環境設定**：
   - ✅ 兩個 Supabase 專案：開發環境 + 正式環境

10. **第一階段功能**：
    - ✅ 資料庫初始化（Prisma schema 建立）
    - ✅ 詞彙資料匯入（現有 dictionary 存入 Supabase）
    - ✅ 基礎認證（匿名 + Email + Google + Apple）
    - ✅ App 讀取詞彙 API

### 備註：
- 匿名用戶資料暫不遷移，未來可能考慮提供遷移選項
- Prisma 用於確保資料庫 schema 版本控制和型別安全
- 成就系統和排行榜都尚未實作，將在 Supabase 整合時一併開發